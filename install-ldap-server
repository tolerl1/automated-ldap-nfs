#!/bin/bash
#Project 2
#Author/Creator by Loagn Toler & Keni Patel
#Team 2
#LDAP Installation
	 
 	 
#store files in /etc/openldap/slapd.d
wget studenthome.nku.edu/~tolerl1/base.ldif > /etc/openldap/
wget studenthome.nku.edu/~tolerl1/db.ldif > /etc/openldap/

#Install LDAP and other packages
echo "Installing OpenLDAP Packages..."
yum -y install openldap-servers openldap-clients migrationtools expect tcl
echo "Installation Complete!"

slappasswd -s CIT470 -n > /etc/openldap/passwd

#Copy DB_CONFIG from usr to var
echo "Copying DB_CONFIG.example..."
cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
slaptest
chown ldap:ldap /var/lib/ldap/*
echo "Copy complete!"

#Starts LDAP and enables it to start on boot
echo "Starting slapd.services..."
systemctl enable slapd.service; systemctl start slapd.service
echo "LDAP started!"

#Configure firewall
echo "Configuring LDAP firewall..." 
firewall-cmd --zone=public --add-port=389/tcp --permanent; firewall-cmd --zone=public --add-port=636/tcp --permanent; firewall-cmd --reload
echo "Firewall configured!"
 	 

  


#make encrypted password
#echo "Generating encrypted password..."
#pass=$(slappasswd -s CIT470 -n)	 
#sed -i "s@olcRootPW: @olcRootPW: $pass@g" db.ldif
ldapmodify -Y EXTERNAL -H ldapi:/// -f /etc/openldap/db.ldif
#echo "Password created!"	 



#add LDAP schemas
echo "Adding LDAP Schemas..."
for def in core.ldif cosine.ldif nis.ldif inetorgperson.ldif; do ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/$def; done
echo "LDAP schemas were successfully added!"

#add ldap tree
echo "Adding LDAP tree..."
ldapadd -x -D "cn=Manager,dc=cit470,dc=nku,dc=edu" -W -f /etc/openldap/base.ldif
echo "Complete!"

#install diradm and create user
#cd /usr/local
#wget http://www.hits.at/diradm/diradm-1.3.tar.gz
#tar zxvf diradm-1.3.tar.gz
#cp /usr/local/diradm-1.3/diradm.conf /etc/
#cd /usr/local/diradm-1.3/
#./diradm useradd -c "LDAP Test Team2" -s /bin/bash -m -p "CIT470" team2
